<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Pessoas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow border-bottom border-secondary">
    <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">üçã Sistema Lim√£o</a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-3" style="font-size: 0.95rem;">
                
                <li class="nav-item"><a class="nav-link text-light" href="cadastro.html">üë• Cadastro</a></li>
                <li class="nav-item"><a class="nav-link text-light" href="parceiros.html">ü§ù Parceiros</a></li>
                <li class="nav-item"><a class="nav-link text-success fw-bold" href="producao.html">üí∞ Produ√ß√£o</a></li>
                <li class="nav-item d-none d-lg-block text-secondary">|</li>
                <li class="nav-item"><a class="nav-link text-warning fw-bold" href="distribuicao.html">üé≤ Distribui√ß√£o</a></li>
                <li class="nav-item"><a class="nav-link text-info fw-bold" href="plantao.html">üìÖ Plant√£o</a></li>
                <li class="nav-item"><a class="nav-link text-danger fw-bold" href="leads.html">üî• Leads</a></li>

                <li class="nav-item dropdown">
                    <a class="nav-link position-relative" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span style="font-size: 1.2rem;">üîî</span>
                        <span id="badge-contador" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" style="font-size: 0.6rem;">
                            0
                        </span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="navbarDropdown" style="width: 320px; max-height: 400px; overflow-y: auto;">
                        <li><h6 class="dropdown-header">Notifica√ß√µes / Lembretes</h6></li>
                        <div id="lista-notificacoes">
                            <li><span class="dropdown-item text-muted small">Nenhuma notifica√ß√£o nova.</span></li>
                        </div>
                    </ul>
                </li>

            </ul>
        </div>
    </div>
</nav>

<script type="module" src="app-notificacoes.js"></script>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <strong>Novo Corretor</strong>
                    </div>
                    <div class="card-body">
                        <form id="form-cadastro">
                            <div class="mb-3">
                                <label>Nome Completo</label>
                                <input type="text" id="nome" class="form-control" required>
                            </div>
                            
                            <div class="mb-3">
                                <label>Telefone / WhatsApp</label>
                                <input type="tel" id="telefone" class="form-control" placeholder="(xx) xxxxx-xxxx" required>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 fw-bold">Salvar Corretor</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <h3>Equipe Cadastrada</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-corretores">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const form = document.getElementById('form-cadastro');
        const lista = document.getElementById('lista-corretores');
        
        // 1. SALVAR
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;

            try {
                await addDoc(collection(db, "corretores"), {
                    nome: nome,
                    telefone: telefone, // Salvando telefone agora
                    // Inicializa campos zerados para n√£o quebrar a produ√ß√£o
                    producao_pme: 0, 
                    producao_pf: 0,
                    saldo_pme: 0,
                    saldo_pf: 0
                });
                alert("Corretor cadastrado com sucesso!");
                form.reset();
            } catch (error) {
                console.error(error);
                alert("Erro ao cadastrar.");
            }
        });

        // 2. LISTAR
        onSnapshot(collection(db, "corretores"), (snap) => {
            let html = '';
            
            if (snap.empty) {
                lista.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum corretor cadastrado.</td></tr>';
                return;
            }

            snap.forEach(d => {
                const dados = d.data();
                // Se for um cadastro antigo que tinha c√≥digo, mostra um tra√ßo ou o c√≥digo antigo
                const contato = dados.telefone || dados.codigo || '-';

                html += `
                    <tr>
                        <td class="fw-bold">${dados.nome}</td>
                        <td>${contato}</td>
                        <td>
                            <button onclick="deletar('${d.id}')" class="btn btn-sm btn-outline-danger">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `;
            });
            lista.innerHTML = html;
        });

        // 3. EXCLUIR
        window.deletar = async (id) => {
            if(confirm("Tem certeza que deseja remover este corretor da equipe?")) {
                await deleteDoc(doc(db, "corretores", id));
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
